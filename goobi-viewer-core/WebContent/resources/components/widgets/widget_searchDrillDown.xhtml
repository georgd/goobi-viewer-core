<ui:composition 
    xmlns="http://www.w3.org/1999/xhtml" 
    xmlns:f="http://xmlns.jcp.org/jsf/core" 
    xmlns:h="http://xmlns.jcp.org/jsf/html"
    xmlns:c="http://java.sun.com/jsp/jstl/core" 
    xmlns:ui="http://xmlns.jcp.org/jsf/facelets" 
    xmlns:composite="http://xmlns.jcp.org/jsf/composite"
    xmlns:goobi="http://xmlns.jcp.org/jsf/composite/components" 
    xmlns:facelets="http://de.intranda.digiverso.presentation"
    xmlns:viewerComponent="http://xmlns.jcp.org/jsf/composite/components">

    <composite:interface>
        <composite:attribute name="widget" type="de.intranda.digiverso.presentation.model.cms.CMSSidebarElement" required="true" />
    </composite:interface>

    <composite:implementation>
        <h:panelGroup rendered="#{cc.attrs.widget.type == 'widgetSearchDrillDown' or cc.attrs.widget.type == null}">
            <h:panelGroup rendered="#{searchBean.facets.availableHierarchicalFacets.entrySet().toArray() != null and searchBean.facets.availableFacets.entrySet().toArray() != null}">
            <div id="searchListDrillDownWrapper" class="widget-search-drilldown #{cc.attrs.widget.cssClass}">
                <h:form id="searchListDrillDownForm" prependId="false">
                    <!-- HIERARCHICAL DRILL DOWN -->
                    <c:forEach var="field" items="#{searchBean.facets.availableHierarchicalFacets.entrySet().toArray()}" varStatus="status">
                        <h:panelGroup 
                            id="collectionDrillDownPanelGroup_#{status.index}"
			                rendered="!searchBean.facets.isHasWrongLanguageCode(field.key, navigationHelper.localeString) and #{(searchBean.facets.getAvailableFacetsListSizeForField(field.key) > 1 or searchBean.facets.getCurrentHierarchicalFacetsSizeForField(field.key) > 0)}">
                            <div class="widget widget-search-drilldown__collection">
                                <h3>#{msg[field.key.concat('_DD')]}</h3>
                                
                                <ul>
                                    <!-- ACTIVE HIERARCHICAL FACETS -->
	                                    <ui:repeat value="#{searchBean.facets.getCurrentHierarchicalFacetsForField(field.key)}" var="facet">
                                        <li class="active">
                                            <h:commandLink action="#{searchBean.removeHierarchicalFacetAction(facet.link)}" title="#{msg.removeFacet}">
												<div class="row">
													<div class="col-xs-11">#{msg[facet.value]}</div>
													<div class="col-xs-1">
														<i class="fa fa-times" aria-hidden="true"></i>
													</div>
												</div>
												<f:passThroughAttribute name="data-toggle" value="tooltip" />
												<f:passThroughAttribute name="data-placement" value="top" />
											</h:commandLink>
										</li>
                                    </ui:repeat>

                                    <!-- AVAILABLE HIERARCHICAL FACETS -->
	                                    <ui:repeat value="#{searchBean.facets.getLimitedHierarchicalFacetListForField(field.key)}" var="facet">
                                        <li>
                                            <h:outputLink rendered="#{!searchBean.facets.isFacetCurrentlyUsed(facet)}" value="#{navigationHelper.getSearchUrl(searchBean.activeSearchType)}/#{searchBean.facets.currentHierarchicalFacetPrefix}#{facet.urlEscapedLink}/#{searchBean.exactSearchString}/#{searchBean.currentPage}/#{searchBean.sortString}/#{searchBean.facets.currentFacetString}/">
                                                #{msg[facet.label]} (#{facet.count})
                                            </h:outputLink>
                                        </li>
                                    </ui:repeat>
                                </ul>
                                
                                <!-- COLLAPSE HIERARCHICAL DRILLDOWN -->
                                <div class="widget-search-drilldown__collapse">
                                    <h:commandLink 
                                        rendered="#{searchBean.facets.isDisplayDrillDownExpandLink(field.key)}"
                                        action="#{searchBean.facets.expandDrillDown(field.key)}" 
                                        title="#{msg.slideDown}">
                                        <f:ajax render="collectionDrillDownPanelGroup_#{status.index}" />
                                        <i class="fa fa-chevron-down" aria-hidden="true"></i>
                                    </h:commandLink>
                                    <h:commandLink 
                                        rendered="#{searchBean.facets.isDisplayDrillDownCollapseLink(field.key)}"
                                        action="#{searchBean.facets.collapseDrillDown(field.key)}" 
                                        title="#{msg.slideUp}">
                                        <f:ajax render="collectionDrillDownPanelGroup_#{status.index}" />
                                        <i class="fa fa-chevron-up" aria-hidden="true"></i>
                                    </h:commandLink>
                                </div>
                            </div>
                        </h:panelGroup>
                    </c:forEach>

                    <!-- ALL OTHER DRILL DOWN -->
                    <c:forEach var="field" items="#{searchBean.facets.availableFacets.entrySet().toArray()}" varStatus="status">
                        <h:panelGroup 
                            id="drillDownPanelGroup_#{status.index}"
                            rendered="#{!searchBean.facets.isHasWrongLanguageCode(field.key, navigationHelper.localeString) and searchBean.facets.getAvailableFacetsListSizeForField(field.key) > 1 or searchBean.facets.getCurrentFacetsSizeForField(field.key) > 0}">
                            <div class="widget widget-search-drilldown__groups">
                                <h3>#{msg[field.key.concat('_DD')]}</h3>
                                <ul>
                                    <!-- ACTIVE FACETS -->
                                    <ui:repeat value="#{searchBean.facets.getCurrentFacetsForField(field.key)}" var="facet">
                                        <li class="active">
                                            <h:commandLink action="#{searchBean.removeFacetAction(facet.link)}" title="#{msg.removeFacet}">
												<div class="row">
													<div class="col-xs-11">#{msg[facet.value]}</div>
													<div class="col-xs-1">
														<i class="fa fa-times" aria-hidden="true"></i>
													</div>
												</div>
												<f:passThroughAttribute name="data-toggle" value="tooltip" />
												<f:passThroughAttribute name="data-placement" value="top" />
                                            </h:commandLink>
                                        </li>
                                    </ui:repeat>

                                    <!-- AVAILABLE FACETS -->
                                    <ui:repeat value="#{searchBean.facets.getLimitedFacetListForField(field.key)}" var="facet">
                                        <li>
                                            <h:outputLink rendered="#{!searchBean.facets.isFacetCurrentlyUsed(facet)}" value="#{navigationHelper.getSearchUrl(searchBean.activeSearchType)}/#{searchBean.facets.currentHierarchicalFacetString}/#{searchBean.exactSearchString}/#{searchBean.currentPage}/#{searchBean.sortString}/#{searchBean.facets.currentFacetStringPrefix}#{facet.urlEscapedLink}/">
                                                #{msg[facet.label]} (#{facet.count})
                                            </h:outputLink></li>
                                    </ui:repeat>
                                </ul>
                                
                                <!-- COLLAPSE DRILLDOWN -->
                                <div class="widget-search-drilldown__collapse">
                                    <h:commandLink 
                                        rendered="#{searchBean.facets.isDisplayDrillDownExpandLink(field.key)}"
                                        action="#{searchBean.facets.expandDrillDown(field.key)}" 
                                        title="#{msg.slideDown}">
                                        <f:ajax render="drillDownPanelGroup_#{status.index}" />
                                        <i class="fa fa-chevron-down" aria-hidden="true"></i>
                                    </h:commandLink>
                                    <h:commandLink 
                                        rendered="#{searchBean.facets.isDisplayDrillDownCollapseLink(field.key)}"
                                        action="#{searchBean.facets.collapseDrillDown(field.key)}" 
                                        title="#{msg.slideUp}">
                                        <f:ajax render="drillDownPanelGroup_#{status.index}" />
                                        <i class="fa fa-chevron-up" aria-hidden="true"></i>
                                    </h:commandLink>
                                </div>
                            </div>
                        </h:panelGroup>
                    </c:forEach>
                </h:form>
            </div>
        </h:panelGroup>
            
            <h:panelGroup rendered="#{searchBean.facets.availableHierarchicalFacets.entrySet().toArray() == null and searchBean.facets.availableFacets.entrySet().toArray() == null}">
            	<div id="widgetSearchHelp" class="widget-searchhelp">
            		<viewerComponent:searchHelpText />
            	</div>
            </h:panelGroup>
        </h:panelGroup>
    </composite:implementation>
</ui:composition>
