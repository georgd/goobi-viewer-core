/*!
 * This file is part of the Goobi viewer - a content presentation and management application for digitized objects.
 *
 * Visit these websites for more information.
 * - http://www.intranda.com
 * - http://digiverso.com
 *
 * This program is free software; you can redistribute it and/or modify it under the terms of the GNU General Public License as published by the Free
 * Software Foundation; either version 2 of the License, or (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE. See the GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License along with this program. If not, see <http://www.gnu.org/licenses/>.
 */
var viewImage=function(){"use strict";var n,a,i={},s=!1,l=null,c={global:{divId:"map",zoomSlider:".zoom-slider",zoomSliderHandle:".zoom-slider-handle",overlayGroups:[{name:"searchHighlighting",styleClass:"coords-highlighting",interactive:!1},{name:"ugc",styleClass:"ugcBox",interactive:!0}],zoomSpeed:1.25,maxZoomLevel:20,minZoomLevel:1,imageControlsActive:!0,visibilityRatio:.4,loadImageTimeout:6e5,maxParallelImageLoads:1,adaptContainerHeight:!1,footerHeight:50,rememberZoom:!1,rememberRotation:!1},image:{},getOverlayGroup:function(e){for(var o=c.global.overlayGroups,t=0;t<o.length;t++){var r=o[t];if(r.name===e)return r}},getCoordinates:function(e){var o=c.image.highlightCoords;if(o)for(var t=0;t<o.length;t++){var r=o[t];if(r.name===e)return r}}};function e(e){if(0<c.global.footerHeight){var o=c.global.footerHeight,t=new OpenSeadragon.Point(0,a.height()-o),r=new OpenSeadragon.Point(a.width(),o);n||(n=i.viewer.drawer.context.canvas.width/i.viewer.drawer.context.canvas.clientWidth),1!=n&&(t=t.times(n),r=r.times(n)),i.viewer.drawer.context.drawImage(l,t.x,t.y,r.x,r.y)}}return i={viewer:null,init:function(e){s&&(console.log("##############################"),console.log("osViewer.init"),console.log("##############################")),$.extend(!0,c,e),c.image.mimeType=c.image.mimeType.replace("jpeg","jpg"),a=$("#"+c.global.divId);var o=c.image.tileSource;"string"==typeof o&&o.startsWith("[")?o=JSON.parse(o):$.isArray(o)||(o=[o]);for(var t=[],r=0;r<o.length;r++){var n=o[r],i=viewImage.createTileSource(n);t.push(i)}return Q.all(t).then(function(e){for(var o=Number.MAX_VALUE,t=Number.MAX_VALUE,r=Number.MAX_VALUE,n=0;n<e.length;n++){var i=e[n];o=Math.min(o,i.width),t=Math.min(t,i.height),r=Math.min(r,i.aspectRatio)}s&&console.log("Min aspect ratio = "+r);for(var a=0,l=0;l<e.length;l++){i=e[l];e[l]={tileSource:i,width:i.aspectRatio/r,x:a,y:0},a+=e[l].width}return viewImage.loadImage(e)})},loadImage:function(e){s&&console.log("Loading image with tilesource: ",e),i.loadFooter(),i.viewer=new OpenSeadragon({immediateRender:!1,visibilityRatio:c.global.visibilityRatio,sequenceMode:!1,id:c.global.divId,controlsEnabled:!1,prefixUrl:"/openseadragon-bin/images/",zoomPerClick:1,maxZoomLevel:c.global.maxZoomLevel,minZoomLevel:c.global.minZoomLevel,zoomPerScroll:c.global.zoomSpeed,mouseNavEnabled:1<c.global.zoomSpeed,showNavigationControl:!1,showZoomControl:!1,showHomeControl:!1,showFullPageControl:!0,timeout:c.global.loadImageTimeout,tileSources:e,blendTime:.5,alwaysBlend:!1,imageLoaderLimit:c.global.maxParallelImageLoads,viewportMargins:{top:0,left:0,right:0,bottom:c.global.footerHeight}});var o,t,r,n=Q.defer();return i.observables=(o=window,t=i.viewer,(r={}).viewerOpen=Rx.Observable.create(function(o){t.addOnceHandler("open",function(e){return e.osState="open",Number.isNaN(e.eventSource.viewport.getHomeBounds().x)?o.onError("Unknow error loading image from ",c.image.tileSource):o.onNext(e)}),t.addOnceHandler("open-failed",function(e){return e.osState="open-failed",console.log("Failed to open openseadragon "),o.onError(e)})}),r.firstTileLoaded=Rx.Observable.create(function(o){t.addOnceHandler("tile-loaded",function(e){return e.osState="tile-loaded",o.onNext(e)}),t.addOnceHandler("tile-load-failed",function(e){return e.osState="tile-load-failed",console.log("Failed to load tile"),o.onError(e)})}),r.viewerZoom=Rx.Observable.create(function(o){t.addHandler("zoom",function(e){return o.onNext(e)})}),r.animationComplete=Rx.Observable.create(function(o){t.addHandler("animation-finish",function(e){return o.onNext(e)})}),r.viewportUpdate=Rx.Observable.create(function(o){t.addHandler("update-viewport",function(e){return o.onNext(e)})}),r.animation=Rx.Observable.create(function(o){t.addHandler("animation",function(e){return o.onNext(e)})}),r.viewerRotate=Rx.Observable.create(function(o){t.addHandler("rotate",function(e){return e.osState="rotate",o.onNext(e)})}),r.canvasResize=Rx.Observable.create(function(o){t.addHandler("resize",function(e){return e.osState="resize",o.onNext(e)})}),r.windowResize=Rx.Observable.fromEvent(o,"resize").map(function(e){return e.osState="window resize",e}),r.overlayRemove=Rx.Observable.create(function(o){t.addHandler("remove-overlay",function(e){return o.onNext(e)})}),r.overlayUpdate=Rx.Observable.create(function(o){t.addHandler("update-overlay",function(e){return o.onNext(e)})}),r.levelUpdate=Rx.Observable.create(function(o){t.addHandler("update-level",function(e){return o.onNext(e)})}),r.redrawRequired=r.viewerOpen.merge(r.viewerRotate.merge(r.canvasResize).debounce(10)).map(function(e){var o={};return i.controls&&(o=i.controls.getLocation()),"open"===e.osState&&(o.zoom=i.viewer.viewport.getHomeZoom(),c.image.location&&(o=c.image.location)),e.targetLocation=o,e}).publish(),r),i.observables.viewerOpen.subscribe(function(e,o){n.resolve(i)},function(e){n.reject(e)}),i.observables.redrawRequired.subscribe(function(e){s&&console.log("viewer "+e.osState+"ed with target location ",e.targetLocation),i.redraw()}),i.controls&&i.controls.init(c),i.zoomSlider&&i.zoomSlider.init(c),i.overlays&&i.overlays.init(c),i.drawRect&&i.drawRect.init(),i.transformRect&&i.transformRect.init(),i.observables.redrawRequired.connect(),n.promise},getObservables:function(){return console.log("Observables = ",i.observables),i.observables},hasFooter:function(){return null!=l},getConfig:function(){return c},loadFooter:function(){c.image.baseFooterUrl&&0<c.global.footerHeight&&((l=new Image).src=c.image.baseFooterUrl.replace("{width}",Math.round(a.width())).replace("{height}",Math.round(c.global.footerHeight)),l.src=c.image.baseFooterUrl.replace("/full/max/","/full/!"+Math.round(a.width())+","+Math.round(c.global.footerHeight)+"/"),l.onload=function(){s&&(console.log("loading footer image ",l),console.log("Calculating image Footer size")),i.drawFooter()})},drawFooter:function(){i.viewer&&e(),i.viewer.removeHandler("update-viewport",e),i.viewer.addHandler("update-viewport",e)},getOverlayGroup:function(e){return c.getOverlayGroup(e)},getHighlightCoordinates:function(e){return c.getCoordinates(e)},createPyramid:function(t){s&&console.log("Creating legacy tilesource from imageInfo ",t);var r=c.image.mimeType;r=(r=r.replace("image/","")).replace("jpeg","jpg").replace("tiff","tif");var e,n=[];return Array.isArray(t)?(t.forEach(function(e){e.mimetype=c.image.mimeType}),e=new OpenSeadragon.LegacyTileSource(t)):t.sizes?(t.sizes.forEach(function(e){s&&(console.log("Image level width = ",e.width),console.log("Image level height = ",e.height));var o={mimetype:c.image.mimeType,url:t["@id"].replace("/info.json","")+"/full/"+e.width+",/0/default."+r,width:t.width,height:t.height};s&&console.log("Created level ",o),n.push(o)}),e=new OpenSeadragon.LegacyTileSource(n)):e=new OpenSeadragon.ImageTileSource({url:t["@id"].replace("/info.json","")+"/full/full/0/default."+r,crossOriginPolicy:"Anonymous",buildPyramid:!1}),e},getSizes:function(){return i.sizes},addImage:function(e,o,t){s&&(console.log("osViewer.addImage: url - "+e),console.log("osViewer.addImage: width - "+o),console.log("osViewer.addImage: height - "+t)),i.viewer?i.viewer.addTiledImage({tileSource:{type:"legacy-image-pyramid",levels:[{url:e,height:t,width:o}]},x:0,y:1.6,width:1}):s&&console.log("Viewer not initialized yet; cannot add image")},getImageInfo:function(){return i.viewer?i.viewer.tileSources:null},getScaleToOriginalSize:function(e){return 1},scaleToOriginalSize:function(e,o){return e},scaleToImageSize:function(e,o){return e},close:function(){s&&console.log("Closing openSeadragon viewer"),i.viewer&&i.viewer.destroy()},redraw:function(){i.controls&&i.controls.setPanning(!0),function(e){s&&(console.log("viewImage: calcualte sizes"),console.log("Home zoom = ",e.viewer.viewport.getHomeZoom()));e.sizes=new viewImage.Measures(e),c.global.adaptContainerHeight&&e.sizes.resizeCanvas();null!=e.viewer&&e.viewer.viewport.setMargins({bottom:e.sizes.footerHeight+e.sizes.calculateExcessHeight()});s&&console.log("sizes: ",e.sizes)}(i)},setImageSizes:function(e,o){if(o){o.replace(/[\{\}]/,""),o=JSON.parse(o);var t=[];o.forEach(function(e){t.push({width:parseInt(e),height:parseInt(e)})}),0<t.length?e.sizes=t:delete e.sizes}},setTileSizes:function(e,t){if(t){var o=viewImage.getConfig().global.tileSizes.replace(/(\d+)/,'"$1"').replace("=",":"),r=(t=JSON.parse(o),[]);Object.keys(t).forEach(function(e){var o=t[e];r.push({width:parseInt(e),height:parseInt(e),scaleFactors:o})}),e.tiles=r}},onFirstTileLoaded:function(){var o=Q.defer();return viewImage.observables?viewImage.observables.firstTileLoaded.subscribe(function(e){o.resolve(e)},function(e){o.reject(e)}):o.reject("No observables defined"),o.promise},createTileSource:function(e){var o=Q.defer();return viewImage.tileSourceResolver.resolveAsJson(e).then(function(e){var o;return s&&console.log("IIIF image info ",e),viewImage.setImageSizes(e,c.global.imageSizes),viewImage.setTileSizes(e,c.global.tileSizes),e.tiles&&0<e.tiles.length?o=new OpenSeadragon.IIIFTileSource(e):(console.log("tiles? ",e.tiles),o=i.createPyramid(e)),o},function(e){if(viewImage.tileSourceResolver.isURI(c.image.tileSource)){s&&console.log("Image URL",c.image.tileSource);var o=new OpenSeadragon.ImageTileSource({url:c.image.tileSource,buildPyramid:!0,crossOriginPolicy:!1});return o}var t="Failed to load tilesource from "+o;return s&&console.log(t),Q.reject(t)}).then(function(e){o.resolve(e)}).catch(function(e){o.reject(e)}),o.promise},scaleToOpenSeadragon:function(e){var o=this.viewer.world.getItemAt(0).source.dimensions,t=this.sizes.originalImageSize.x/o.x;return e=(e=e.times(1/o.x)).times(1/t)},scaleToImage:function(e){var o=this.viewer.world.getItemAt(0).source.dimensions,t=this.sizes.originalImageSize.x/o.x;return e=(e=e.times(o.x)).times(t)}}}(jQuery,OpenSeadragon);String.prototype.startsWith||(String.prototype.startsWith=function(e){return 0===this.substring(0,e.length).localeCompare(e)}),String.prototype.endsWith||(String.prototype.endsWith=function(e){return 0===this.substring(this.length-e.length,this.length).localeCompare(e)}),Array.prototype.find||(Array.prototype.find=function(e){for(var o=0;o<this.length;o++){var t=this[o];if(e(t))return t}}),Number.isNaN||(Number.isNaN=function(e){return e!=e});viewImage=function(i){"use strict";var a={},l={global:{sliderDilation:12}};return i.zoomSlider={init:function(e){$.extend(!0,l,e),$(l.global.zoomSlider)&&(i.zoomSlider.addZoomSlider(l.global.zoomSlider),i.viewer.addHandler("zoom",function(e){i.zoomSlider.buttonToZoom(e.zoom)}))},buttonToMouse:function(e){var o=a.$button.width()/2,t=e-o;t<0&&(t=0),t+2*o>a.absoluteWidth&&(t=a.absoluteWidth-2*o),a.$button.css({left:t});var r=(a.buttonPosition=t)/(a.absoluteWidth-2*o);r=1/l.global.sliderDilation*Math.tan(Math.atan(l.global.sliderDilation)*r);var n=i.viewer.viewport.getMinZoom()+(i.viewer.viewport.getMaxZoom()-i.viewer.viewport.getMinZoom())*r;i.controls.zoomTo(n)},buttonToZoom:function(e){if(a&&i.viewer.viewport){var o=(e-i.viewer.viewport.getMinZoom())/(i.viewer.viewport.getMaxZoom()-i.viewer.viewport.getMinZoom()),t=(o=1/Math.atan(l.global.sliderDilation)*Math.atan(l.global.sliderDilation*o))*(a.absoluteWidth-a.$button.width());Math.abs(i.viewer.viewport.getMaxZoom()-e)<1e-10&&(t=a.absoluteWidth-a.$button.width()),t<0&&(t=0),a.$button.css({left:t}),a.buttonPosition=t}},zoomSliderMouseUp:function(){a.mousedown=!1},zoomSliderMouseMove:function(e){if(a.mousedown){var o=$(this).offset(),t=e.pageX-o.left;i.zoomSlider.buttonToMouse(t)}},zoomSliderMouseDown:function(e){a.mousedown=!0;var o=$(this).offset(),t=e.pageX-o.left;i.zoomSlider.buttonToMouse(t)},buttonMouseDown:function(){return!(a.mousedown=!0)},addZoomSlider:function(e){a.$element=$(e),a.$button=a.$element.children(l.global.zoomSliderHandle),a.buttonPosition=0,a.absoluteWidth=a.$element.innerWidth(),a.mousedown=!1,a.$button.on("mousedown",i.zoomSlider.buttonMouseDown),a.$element.click(i.zoomSlider._zoomSliderClick),a.$element.mousedown(i.zoomSlider.zoomSliderMouseDown),a.$element.mousemove(i.zoomSlider.zoomSliderMouseMove),$(document).on("mouseup",i.zoomSlider.zoomSliderMouseUp)}},i}((viewImage=function(s){"use strict";var i="default",a=!1,t="transforming",l=!1,c=!1,r=null,g=.004,u="",d=null;function e(e){if(!c&&l){var o=s.viewer.viewport.viewerElementToViewportCoordinates(e.position);o=s.overlays.getRotated(o);var t=s.overlays.getDrawingOverlay().rect,r=(s.overlays.getDrawingOverlay().element,s.viewer.element),n=w(t,o,g);return n||(n=f(t,o,g)),!n&&s.overlays.contains(t,o,0)&&(n=s.transformRect.hitAreas.CENTER),n?$(r).css({cursor:s.transformRect.hitAreas.getCursor(n)}):$(r).css({cursor:i}),e.preventDefaultAction=!0}}function o(e){if(l){if(!s.overlays.getDrawingOverlay())return!1;var o=s.overlays.getDrawingOverlay().rect,t=s.overlays.getDrawingOverlay().element,r=s.viewer.viewport.viewerElementToViewportCoordinates(e.position),n=w(o,r=s.overlays.getRotated(r),g);return n||(n=f(o,r,g)),!n&&s.overlays.contains(o,r,0)&&(n=s.transformRect.hitAreas.CENTER),a&&console.log("draw area = "+n),n&&($(t).tooltip("destroy"),d=r),u=n,e.preventDefaultAction=!0}}function n(e){if(c){var o=s.viewer.viewport.viewerElementToViewportCoordinates(e.position);o=s.overlays.getRotated(o);var t,r,n=s.overlays.getDrawingOverlay().rect;if(u===s.transformRect.hitAreas.TOPLEFT)t=new OpenSeadragon.Point(Math.min(o.x,n.getBottomRight().x),Math.min(o.y,n.getBottomRight().y)),r=n.getBottomRight();else if(u===s.transformRect.hitAreas.TOPRIGHT)t=new OpenSeadragon.Point(n.getTopLeft().x,Math.min(o.y,n.getBottomRight().y)),r=new OpenSeadragon.Point(Math.max(o.x,n.getTopLeft().x),n.getBottomRight().y);else if(u===s.transformRect.hitAreas.BOTTOMLEFT)t=new OpenSeadragon.Point(Math.min(o.x,n.getBottomRight().x),n.getTopLeft().y),r=new OpenSeadragon.Point(n.getBottomRight().x,Math.max(o.y,n.getTopLeft().y));else if(u===s.transformRect.hitAreas.BOTTOMRIGHT)t=n.getTopLeft(),r=new OpenSeadragon.Point(Math.max(o.x,n.getTopLeft().x),Math.max(o.y,n.getTopLeft().y));else if(u===s.transformRect.hitAreas.LEFT)t=new OpenSeadragon.Point(Math.min(o.x,n.getBottomRight().x),n.getTopLeft().y),r=n.getBottomRight();else if(u===s.transformRect.hitAreas.RIGHT)t=n.getTopLeft(),r=new OpenSeadragon.Point(Math.max(o.x,n.getTopLeft().x),n.getBottomRight().y);else if(u===s.transformRect.hitAreas.TOP)t=new OpenSeadragon.Point(n.getTopLeft().x,Math.min(o.y,n.getBottomRight().y)),r=n.getBottomRight();else if(u===s.transformRect.hitAreas.BOTTOM)t=n.getTopLeft(),r=new OpenSeadragon.Point(n.getBottomRight().x,Math.max(o.y,n.getTopLeft().y));else if(u===s.transformRect.hitAreas.CENTER&&d){var i=d.x-o.x,a=d.y-o.y;n.x-=i,n.y-=a,d=o}return t&&r&&(n.x=t.x,n.y=t.y,n.width=r.x-t.x,n.height=r.y-t.y),s.viewer.updateOverlay(s.overlays.getDrawingOverlay().element,n,0),e.preventDefaultAction=!0}if(u)return c=!0,e.preventDefaultAction=!0}function v(e){if(l)return c&&r&&r(s.overlays.getDrawingOverlay()),c=!1,s.overlays.getDrawingOverlay()&&$(s.overlays.getDrawingOverlay().element).tooltip(),u="",d=null,e.preventDefaultAction=!0}function m(e){if(c)return c=!1,e.preventDefaultAction=!0}function h(e){if(c)return e.preventDefaultAction=!0}function f(e,o,t){var r=b(o,e.getTopLeft(),e.getBottomLeft()),n=b(o,e.getBottomLeft(),e.getBottomRight()),i=b(o,e.getTopRight(),e.getBottomRight()),a=b(o,e.getTopLeft(),e.getTopRight()),l=Math.min(r,Math.min(i,Math.min(a,n)));if(l<=t){if(r===l)return s.transformRect.hitAreas.LEFT;if(i===l)return s.transformRect.hitAreas.RIGHT;if(a===l)return s.transformRect.hitAreas.TOP;if(n===l)return s.transformRect.hitAreas.BOTTOM}return""}function w(e,o,t){var r=S(o,e.getTopLeft()),n=S(o,e.getBottomLeft()),i=S(o,e.getTopRight()),a=S(o,e.getBottomRight()),l=Math.min(r,Math.min(i,Math.min(n,a)));if(l<=t){if(r===l)return s.transformRect.hitAreas.TOPLEFT;if(i===l)return s.transformRect.hitAreas.TOPRIGHT;if(n===l)return s.transformRect.hitAreas.BOTTOMLEFT;if(a===l)return s.transformRect.hitAreas.BOTTOMRIGHT}return""}function p(e){return e*e}function y(e,o){return p(e.x-o.x)+p(e.y-o.y)}function S(e,o){return Math.sqrt(y(e,o))}function b(e,o,t){return Math.sqrt(function(e,o,t){var r=y(o,t);if(0==r)return y(e,o);var n=((e.x-o.x)*(t.x-o.x)+(e.y-o.y)*(t.y-o.y))/r;return y(e,n<0?o:1<n?t:{x:o.x+n*(t.x-o.x),y:o.y+n*(t.y-o.y)})}(e,o,t))}return s.transformRect={init:function(){a&&(console.log("##############################"),console.log("osViewer.transformRect.init"),console.log("##############################")),s.viewer.addViewerInputHook({hooks:[{tracker:"viewer",handler:"clickHandler",hookHandler:h},{tracker:"viewer",handler:"dragHandler",hookHandler:n},{tracker:"viewer",handler:"pressHandler",hookHandler:o},{tracker:"viewer",handler:"dragEndHandler",hookHandler:m},{tracker:"viewer",handler:"releaseHandler",hookHandler:v},{tracker:"viewer",handler:"moveHandler",hookHandler:e}]})},startDrawing:function(e,o){a&&console.log("Start drawing"),s.overlays.setDrawingOverlay(e),l=!0,e.group,r=o,$(e.element).addClass(t)},endDrawing:function(){r=null,l=c=!1;var e=s.overlays.getDrawingOverlay();null!=e&&($(e.element).removeClass(t),$(e.element).css({cursor:i}))},isActive:function(){return l},hitAreas:{TOP:"t",BOTTOM:"b",RIGHT:"r",LEFT:"l",TOPLEFT:"tl",TOPRIGHT:"tr",BOTTOMLEFT:"bl",BOTTOMRIGHT:"br",CENTER:"c",isCorner:function(e){return e===this.TOPRIGHT||e===this.TOPLEFT||e===this.BOTTOMLEFT||e===this.BOTTOMRIGHT},isEdge:function(e){return e===this.TOP||e===this.BOTTOM||e===this.LEFT||e===this.RIGHT},getCursor:function(e){var o=s.viewer.viewport.getRotation()%180==90;return e===this.TOPLEFT||e===this.BOTTOMRIGHT?o?"nesw-resize":"nwse-resize":e===this.TOPRIGHT||e===this.BOTTOMLEFT?o?"nwse-resize":"nesw-resize":e===this.TOP||e===this.BOTTOM?o?"ew-resize":"ns-resize":e===this.RIGHT||e===this.LEFT?o?"ns-resize":"ew-resize":e===this.CENTER?"move":i}}},s}((viewImage=function(n){"use strict";return n.tileSourceResolver={resolveAsJsonOrURI:function(e){var o=Q.defer();return this.isJson(e)?o.resolve(e):this.isStringifiedJson(e)?o.resolve(JSON.parse(e)):o.resolve(e),o.promise},resolveAsJson:function(e){var o=Q.defer();if(this.isURI(e)){if(this.isJsonURI(e))return this.loadJsonFromURL(e);o.reject("Url does not lead to a json object")}else if("string"==typeof e)try{var t=JSON.parse(e);o.resolve(t)}catch(e){o.reject("String does not contain valid json: "+e)}else"object"==typeof e?o.resolve(e):o.reject("Neither a url nor a json object");return o.promise},loadJsonFromURL:function(e){var o=Q.defer();return this.isJsonURI(e)?OpenSeadragon.makeAjaxRequest(e,function(e){try{o.resolve(JSON.parse(e.responseText))}catch(e){o.reject(e)}},function(e){o.reject(e)}):o.reject("Not a json uri: "+e),o.promise},loadIfJsonURL:function(r){return Q.promise(function(o,t){if(n.tileSourceResolver.isURI(r)){var e={url:decodeURI(r),type:"GET",dataType:"JSON",async:!0,crossDomain:!0,accepts:{application_json:"application/json",application_jsonLd:"application/ld+json",text_json:"text/json",text_jsonLd:"text/ld+json"}};Q($.ajax(e)).then(function(e){o(e)}).fail(function(e){t("Failed to retrieve json from "+r)}),setTimeout(function(){t("Timeout after 10s")},1e4)}else t("Not a uri: "+r)})},isJsonURI:function(e){if(this.isURI(e)){var o=e.replace(/\?.*/,"");return o.endsWith("/")&&(o=o.substring(0,o.length-1)),o.toLowerCase().endsWith(".json")}return!1},isURI:function(e){return!(!e||"string"!=typeof e||!(e.startsWith("http://")||e.startsWith("https://")||e.startsWith("file:/")))},isStringifiedJson:function(e){if(e&&"string"==typeof e)try{var o=JSON.parse(e);return this.isJson(o)}catch(e){return!1}return!1},isJson:function(e){return e&&"object"==typeof e}},n}((viewImage=function(e){"use strict";var i=!1,o=null,a={navSelector:".reading-mode__navigation",viewSelector:"#contentView",imageContainerSelector:".reading-mode__content-view-image",imageSelector:"#readingModeImage",sidebarSelector:"#contentSidebar",sidebarToggleButton:".reading-mode__content-sidebar-toggle",sidebarInnerSelector:".reading-mode__content-sidebar-inner",sidebarTabsSelector:".reading-mode__content-sidebar-tabs",sidebarTabContentSelector:".tab-content",sidebarTocWrapperSelector:".widget-toc-elem-wrapp",sidebarStatus:"",useTabs:!0,useAccordeon:!1,msg:{}};function t(){i&&(console.log("---------- _setViewportHeight() ----------"),console.log("_setViewportHeight: view = ",a.viewSelector),console.log("_setViewportHeight: image = ",a.imageSelector),console.log("_setViewportHeight: sidebar = ",a.sidebarSelector),console.log("_setViewportHeight: sidebarInner = ",a.sidebarInnerSelector),console.log("_setViewportHeight: sidebarTabs = ",a.sidebarTabsSelector));var e=$(window).outerHeight(),o=$(a.navSelector).outerHeight(),t=e-o;i&&(console.log("_setViewportHeight: viewportHeight = ",e),console.log("_setViewportHeight: navHeight = ",o),console.log("_setViewportHeight: newHeight = ",t)),$(a.viewSelector).css("height",t),$(a.imageSelector).css("height",t),$(a.sidebarSelector).css("height",t),$(a.sidebarInnerSelector).css("height",t)}function r(){i&&(console.log("---------- _setSidebarTabHeight() ----------"),console.log("_setSidebarTabHeight: sidebarTabs = ",a.sidebarTabsSelector));var e=$(window).outerHeight(),o=e-$(a.navSelector).outerHeight(),t=$(a.sidebarTabsSelector).position(),r=o-t.top-15,n=$(".nav-tabs").outerHeight();i&&(console.log("_setSidebarTabHeight: tabPos = ",t),console.log("_setSidebarTabHeight: tabHeight = ",r)),768<e&&($(a.sidebarTabsSelector).css("height",r),$(a.sidebarTabContentSelector).css("height",r-n),$(a.sidebarTocWrapperSelector).css("min-height",r-n))}function n(){i&&(console.log("---------- _setSidebarButtonPosition() ----------"),console.log("_setSidebarButtonPosition: view = ",a.viewSelector));var e=$(a.viewSelector).outerHeight()/2;i&&console.log("_setSidebarButtonPosition: viewHalfHeight = ",e),$(a.sidebarToggleButton).css("top",e)}return e.readingMode={init:function(e){if(i&&(console.log("##############################"),console.log("osViewer.readingMode.init"),console.log("##############################"),console.log("osViewer.readingMode.init: config - ",e)),$.extend(!0,a,e),!viewerJS.helper.checkLocalStorage())return!1;a.sidebarStatus=localStorage.getItem("sidebarStatus"),""!==a.sidebarStatus&&void 0!==a.sidebarStatus||localStorage.setItem("sidebarStatus","true"),t(),a.useTabs&&r(),n(),function(){i&&(console.log("---------- _checkSidebarStatus() ----------"),console.log("_checkSidebarStatus: sidebarStatus = ",a.sidebarStatus));"false"!==a.sidebarStatus||($('[data-toggle="sidebar"]').removeClass("in"),$(".reading-mode__content-sidebar").removeClass("in").prev().removeClass("in"))}(),setTimeout(function(){!function(){i&&console.log("---------- _showContent() ----------");$(a.viewSelector).removeClass("invisible"),$(a.sidebarSelector).removeClass("invisible")}()},500),a.useAccordeon&&(o=localStorage.getItem("activePanel"),$(".panel-collapse").each(function(){$(this).removeClass("in")}),null===o&&(localStorage.setItem("activePanel","#collapseOne"),o=localStorage.getItem("activePanel")),$(o).addClass("in"),$('a[data-toggle="collapse"]').on("click",function(){var e=$(this).attr("href");localStorage.setItem("activePanel",e)})),$('[data-toggle="sidebar"]').on("click",function(){$(this).toggleClass("in"),$(this).parents(".reading-mode__content-sidebar").toggleClass("in"),$(this).parents(".reading-mode__content-sidebar").prev().toggleClass("in"),a.sidebarStatus=localStorage.getItem("sidebarStatus"),"false"===a.sidebarStatus?localStorage.setItem("sidebarStatus","true"):localStorage.setItem("sidebarStatus","false")}),$(window).on("resize",function(){t(),a.useTabs&&r(),n()}),$(window).on("orientationchange",function(){t(),a.useTabs&&r(),n()}),"undefined"!=typeof jsf&&jsf.ajax.addOnEvent(function(e){switch(e.status){case"success":t(),a.useTabs&&r(),n()}})}},e}((viewImage=function(f){"use strict";var w=!1,r="focus",n="highlight",i=null,a=null,t=null,p=[],y={},l=null;function s(e,o,t,r,n,i,a,l){w&&(console.log("------------------------------"),console.log("Overlays _createRectangle: x - "+e),console.log("Overlays _createRectangle: y - "+o),console.log("Overlays _createRectangle: width - "+t),console.log("Overlays _createRectangle: height - "+r),console.log("Overlays _createRectangle: title - "+n),console.log("Overlays _createRectangle: id - "+i),console.log("Overlays _createRectangle: group - "+a),console.log("Overlays _createRectangle: imageIndex - "+l),console.log("------------------------------")),e=f.scaleToImageSize(e),o=f.scaleToImageSize(o),t=f.scaleToImageSize(t),r=f.scaleToImageSize(r),l||(l=0);var s=f.viewer.world.getItemAt(l).imageToViewportRectangle(e,o,t,r),c={type:f.overlays.overlayTypes.RECTANGLE,rect:s,group:a,id:i,title:n};y.getOverlayGroup(c.group).hidden||S(c),p.push(c)}function S(o){w&&(console.log("viewImage.overlays._drawOverlay"),console.log("overlay: ",o));var t=document.createElement("div");$(t).attr("id","overlay_"+o.id);var e=y.getOverlayGroup(o.group);e&&(w&&console.log("overlay style",e),$(t).addClass(e.styleClass),o.type===f.overlays.overlayTypes.LINE&&function(e,o){w&&(console.log("Overlays _rotate: angle - "+e),console.log("Overlays _rotate: mapElement - "+o));if(0!==e){$(o).css("-moz-transform","rotate("+e+"deg)"),$(o).css("-webkit-transform","rotate("+e+"deg)"),$(o).css("-ms-transform","rotate("+e+"deg)"),$(o).css("-o-transform","rotate("+e+"deg)"),$(o).css("transform","rotate("+e+"deg)");var t=Math.sin(e),r=Math.cos(e);$(o).css("filter","progid:DXImageTransform.Microsoft.Matrix(M11="+r+", M12="+t+", M21=-"+t+", M22="+r+", sizingMethod='auto expand'")}}(o.angle,t),e.interactive&&(t.focus=function(e){e?($(t).addClass(r),function(t,e){if(e.title){var r=f.sizes.$container.offset(),o=$(t).offset().top,n=$(t).offset().left,i=($(t).outerHeight(),n+$(t).outerWidth()),a=$("<div class='tooltipp'>"+e.title+"</div>");$("body").append(a);var l=parseFloat(a.css("padding-top"));a.css("max-width",i-n),a.css("top",Math.max(r.top+l,o-a.outerHeight()-l)),a.css("left",Math.max(r.left+l,n)),a.attr("id","tooltip_"+e.id),f.observables.animation.do(function(){var e=Math.max($(t).offset().top,r.top),o=Math.max($(t).offset().left,r.left);a.css("top",Math.max(r.top+l,e-a.outerHeight()-l)),a.css("left",Math.max(r.left+l,o))}).takeWhile(function(){return 0<$(".tooltipp").length}).subscribe()}}(t,o)):($(t).removeClass(r),$(".tooltipp#tooltip_"+o.id).remove()),i&&i(o,e)},t.highlight=function(e){e?$(t).addClass(n):$(t).removeClass(n)},$(t).on("mouseover",function(){w&&console.log("Overlays _drawOverlay: mouse over - "+e.name),f.overlays.focusBox(o.group,o.id)}),$(t).on("mouseout",function(){w&&console.log("Overlays _drawOverlay: mouse out - "+e.name),t.focus(!1)}),$(t).on("click",function(){a&&a(o)})),o.element=t,f.viewer.addOverlay(t,o.rect,0))}function c(e,o,t){return o.x>e.x-t&&o.x<e.x+e.width+t&&o.y>e.y-t&&o.y<e.y+e.height+t}function e(e){var o=e.position,t=viewerJS.helper.detectIEVersion();t&&10===t&&(o.x+=$(window).scrollLeft(),o.y+=$(window).scrollTop());var r=f.viewer.viewport.viewerElementToViewportCoordinates(o);p.forEach(function(e){c(e.rect,r,0)?f.overlays.showOverlay(e):f.overlays.hideOverlay(e)})}return f.overlays={init:function(e){w&&(console.log("##############################"),console.log("osViewer.overlays.init"),console.log("##############################")),$.extend(!0,y,e),f.observables.overlayRemove.subscribe(function(e){e.element&&$(e.element).remove()}),y.image.highlightCoords&&f.observables.viewerOpen.subscribe(function(e){for(var o=0;o<y.image.highlightCoords.length;o++){var t=y.image.highlightCoords[o],r=t.pageIndex;f.overlays.draw(t.name,t.displayTooltip,r)}l&&l()})},onInitialized:function(e){var o=l;l=function(){o&&o(),e()}},onFocus:function(t){var r=i;i=function(e,o){r&&r(e,o),t(e,o)}},onClick:function(o){var t=a;a=function(e){t&&t(e),o(e)}},getOverlays:function(){return p.slice()},getRects:function(){return p.filter(function(e){return e.type===f.overlays.overlayTypes.RECTANGLE}).slice()},getLines:function(){return p.filter(function(e){return e.type===f.overlays.overlayTypes.LINE}).slice()},draw:function(e,o,t){w&&(console.log("osViewer.overlays.draw: group - "+e),console.log("osViewer.overlays.draw: displayTitle - "+o),console.log("osViewer.overlays.draw: imageIndex - "+t));var r=y.getCoordinates(e);if(r)for(var n=0;n<r.coordinates.length;n++){var i=r.coordinates[n],a=o&&4<i.length?i[4]:"",l=5<i.length?i[5]:n;s(i[0],i[1],i[2]-i[0],i[3]-i[1],a,l,e,t)}},unDraw:function(o){w&&console.log("osViewer.overlays.unDraw: group - "+o);p=p.filter(function(e){return e.group!==o||(f.viewer.removeOverlay(e.element),!1)})},highlight:function(o){w&&console.log("osViewer.overlays.highlight: group - "+o),p.filter(function(e){return e.group===o}).forEach(function(e){e.element&&e.element.highlight(!0)})},unHighlight:function(o){w&&console.log("osViewer.overlays.unHighlight: group - "+o),p.filter(function(e){return e.group===o}).forEach(function(e){e.element&&e.element.highlight(!1)})},focusBox:function(o,t){w&&(console.log("osViewer.overlays.highlightBox: group - "+o),console.log("osViewer.overlays.highlightBox: id - "+t)),p.filter(function(e){return e.group===o}).forEach(function(e){e.element&&e.element.focus(e.id===t)})},addOverlay:function(e){w&&console.log("osViewer.overlays.addOverlay: overlay - "+e),p.push(e),e.element&&f.viewer.updateOverlay(e.element,e.rect,0)},removeOverlay:function(e){if(e){w&&console.log("Removing overlay "+e.id);var o=p.indexOf(e);p.splice(o,1),e.element&&f.viewer.removeOverlay(e.element)}},drawRect:function(e,o,t,r){w&&(console.log("osViewer.overlays.drawRect: rectangle - "+e),console.log("osViewer.overlays.drawRect: group - "+o)),s(e.x,e.y,e.width,e.height,t||"",r||"",o)},drawLine:function(e,o,t){w&&(console.log("osViewer.overlays.drawLine: point1 - "+e),console.log("osViewer.overlays.drawLine: point2 - "+o),console.log("osViewer.overlays.drawLine: group - "+t)),function(e,o,t,r,n,i,a){w&&(console.log("------------------------------"),console.log("Overlays _createLine: x1 - "+e),console.log("Overlays _createLine: y1 - "+o),console.log("Overlays _createLine: x2 - "+t),console.log("Overlays _createLine: y2 - "+r),console.log("Overlays _createLine: title - "+n),console.log("Overlays _createLine: id - "+i),console.log("Overlays _createLine: group - "+a),console.log("------------------------------"));e=f.scaleToImageSize(e),o=f.scaleToImageSize(o),t=f.scaleToImageSize(t),r=f.scaleToImageSize(r);var l=new OpenSeadragon.Point(e,o),s=new OpenSeadragon.Point(t,r),c=l.distanceTo(s),g=function(e,o){w&&(console.log("Overlays _calculateAngle: p1 - "+e),console.log("Overlays _calculateAngle: p2 - "+o));var t=o.x-e.x,r=o.y-e.y;return 0<t?180*Math.atan(r/t)/Math.PI:t<0?180*Math.atan(r/t)/Math.PI+180:r<0?270:90}(l,s),u=(180-g)/2;o+=c/2*Math.sin(g*Math.PI/180),e-=c/2*Math.sin(g*Math.PI/180)/Math.tan(u*Math.PI/180);var d=f.viewer.viewport.imageToViewportRectangle(e,o,c,1),v=f.viewer.viewport.imageToViewportCoordinates(l),m=f.viewer.viewport.imageToViewportCoordinates(s),h={type:f.overlays.overlayTypes.LINE,rect:d,angle:g,point1:v,point2:m,group:a,id:i,title:n};y.getOverlayGroup(h.group).hidden||S(h);p.push(h)}(e.x,e.y,o.x,o.y,"","",t)},showOverlay:function(e){e&&!e.element&&(S(e),i&&i(e,!0))},hideOverlay:function(e){var o;e&&e.element&&t!=e&&(o=e,f.viewer.removeOverlay(o.element),o.element=null,i&&i(e,!1))},getOverlay:function(o,t){return p.find(function(e){return t?e.id===o&&e.group===t:e.id===o})},getCoordinates:function(e){if(w&&console.log("getCoordinates - overlay",e),e.type===f.overlays.overlayTypes.RECTANGLE){var o=f.viewer.viewport.viewportToImageRectangle(e.rect);return o=o.times(f.getScaleToOriginalSize())}if(e.type===f.overlays.overlayTypes.LINE)return{point1:f.viewer.viewport.viewportToImageCoordinates(e.poin1),point2:f.viewer.viewport.viewportToImageCoordinates(e.poin2)}},getDrawingOverlay:function(){return t},setDrawingOverlay:function(e){t=e},showHiddenOverlays:function(){f.viewer.addViewerInputHook({hooks:[{tracker:"viewer",handler:"moveHandler",hookHandler:e}]})},contains:function(e,o,t){return null==t&&(t=0),c(e,o,t)},overlayTypes:{RECTANGLE:"rectangle",LINE:"line"},getRotated:function(e){return e}},f}((viewImage=function(e){"use strict";return e.Measures=function(e){this.config=e.getConfig(),this.$container=$("#"+this.config.global.divId),this.outerCanvasSize=new OpenSeadragon.Point(this.$container.outerWidth(),this.$container.outerHeight()),this.innerCanvasSize=new OpenSeadragon.Point(this.$container.width(),this.$container.height()),this.originalImageSize=new OpenSeadragon.Point(this.getTotalImageWidth(e.getImageInfo()),this.getMaxImageHeight(e.getImageInfo())),this.footerHeight=this.config.global.footerHeight,this.rotation=null!=e.viewer?e.viewer.viewport.getRotation():0,this.xPadding=this.outerCanvasSize.x-this.innerCanvasSize.x,this.yPadding=this.outerCanvasSize.y-this.innerCanvasSize.y,this.innerCanvasSize.y-=this.footerHeight,this.fitToHeight()?this.imageDisplaySize=new OpenSeadragon.Point(this.innerCanvasSize.y/this.ratio(this.getRotatedSize(this.originalImageSize)),this.innerCanvasSize.y):this.imageDisplaySize=new OpenSeadragon.Point(this.innerCanvasSize.x,this.innerCanvasSize.x*this.ratio(this.getRotatedSize(this.originalImageSize))),this.rotated()&&(this.imageDisplaySize=this.getRotatedSize(this.imageDisplaySize))},e.Measures.prototype.getMaxImageWidth=function(e){var o=0;if(e&&0<e.length)for(var t=0;t<e.length;t++){var r=e[t];r.tileSource&&(correction=r.width,r=r.tileSource),o=Math.max(o,r.width*correction)}return o},e.Measures.prototype.getMaxImageHeight=function(e){var o=0;if(e&&0<e.length)for(var t=0;t<e.length;t++){var r=e[t],n=1;r.tileSource&&(n=r.width,r=r.tileSource),o=Math.max(o,r.height*n)}return o},e.Measures.prototype.getTotalImageWidth=function(e){var o=0;if(e&&0<e.length)for(var t=0;t<e.length;t++){var r=e[t],n=1;r.tileSource&&(n=r.width,r=r.tileSource),o+=r.width*n}return o},e.Measures.prototype.getTotalImageHeight=function(e){var o=0;if(e&&0<e.length)for(var t=0;t<e.length;t++){var r=e[t];r.tileSource&&(correction=r.width,r=r.tileSource),o+=r.height*correction}return o},e.Measures.prototype.getImageHomeSize=function(){var e=this.rotated()?1/this.ratio(this.originalImageSize):this.ratio(this.originalImageSize);if(this.fitToHeight())var o=(t=this.innerCanvasSize.y)/e;else var t=(o=this.innerCanvasSize.x)*e;return this.getRotatedSize(new OpenSeadragon.Point(o,t))},e.Measures.prototype.rotated=function(){return this.rotation%180!=0},e.Measures.prototype.landscape=function(){return this.ratio(this.originalImageSize)<1},e.Measures.prototype.ratio=function(e){return e.y/e.x},e.Measures.prototype.getRotatedSize=function(e){return new OpenSeadragon.Point(this.rotated()?e.y:e.x,this.rotated()?e.x:e.y)},e.Measures.prototype.fitToHeight=function(){return!this.config.global.adaptContainerHeight&&this.ratio(this.getRotatedSize(this.originalImageSize))>this.ratio(this.innerCanvasSize)},e.Measures.prototype.resizeCanvas=function(){this.config.global.adaptContainerHeight&&this.$container.height(this.getRotatedSize(this.imageDisplaySize).y+this.footerHeight),this.outerCanvasSize=new OpenSeadragon.Point(this.$container.outerWidth(),this.$container.outerHeight()),this.innerCanvasSize=new OpenSeadragon.Point(this.$container.width(),this.$container.height()-this.footerHeight)},e.Measures.prototype.calculateExcessHeight=function(){var e=this.getRotatedSize(this.getImageHomeSize());return this.config.global.adaptContainerHeight||this.fitToHeight()?0:.5*(this.innerCanvasSize.y-e.y)},e}((viewImage=function(n){"use strict";var i=!1,a="drawing",l=!1,s=!1,c=null,g=null,u=5,d=.01,v=!0,m=null,h=null;function e(e){if(l)return h=n.viewer.viewport.viewerElementToViewportCoordinates(e.position),!(e.preventDefaultAction=!1)}function o(e){if(s){var o=n.viewer.viewport.viewerElementToViewportCoordinates(e.position),t=new OpenSeadragon.Rect(h.x,h.y,o.x-h.x,o.y-h.y);return o.x<h.x&&(t.x=o.x,t.width=h.x-o.x),o.y<h.y&&(t.y=o.y,t.height=h.y-o.y),n.viewer.updateOverlay(m,t,0),e.preventDefaultAction=!0}if(l&&h){var r=n.overlays.getDrawingOverlay();if(r&&n.transformRect&&n.transformRect.isActive()&&n.overlays.contains(r.rect,h,d))h=null,i&&console.log("Action overlaps active overlay");else{s=!0,r&&v&&n.overlays.removeOverlay(r),m=document.createElement("div"),c&&$(m).addClass(c.styleClass),$(m).addClass(a);t=new OpenSeadragon.Rect(h.x,h.y,0,0);n.viewer.addOverlay(m,t,1)}return e.preventDefaultAction=!0}}function t(e){if(s){s=!1;var o=n.viewer.viewport.viewerElementToViewportCoordinates(e.position),t=new OpenSeadragon.Rect(h.x,h.y,o.x-h.x,o.y-h.y);o.x<h.x&&(t.x=o.x,t.width=h.x-o.x),o.y<h.y&&(t.y=o.y,t.height=h.y-o.y),t.hitBox={l:t.x-u,t:t.y-u,r:t.x+t.width+u,b:t.y+t.height+u};var r={type:n.overlays.overlayTypes.RECTANGLE,element:m,rect:t,group:c.name};return n.overlays.setDrawingOverlay(r),g&&g(r),e.preventDefaultAction=!0}}function r(e){if(l)return e.preventDefaultAction=!0}return n.drawRect={init:function(){i&&(console.log("##############################"),console.log("osViewer.drawRect.init"),console.log("##############################")),n.viewer.addViewerInputHook({hooks:[{tracker:"viewer",handler:"clickHandler",hookHandler:r},{tracker:"viewer",handler:"dragHandler",hookHandler:o},{tracker:"viewer",handler:"pressHandler",hookHandler:e},{tracker:"viewer",handler:"dragEndHandler",hookHandler:t}]})},startDrawing:function(e,o){l=!0,c=e,g=o},endDrawing:function(e){l=!1,g=c=null,m&&e?n.viewer.removeOverlay(m):$(m).removeClass(a)},isActive:function(){return l},isDrawing:function(){return s},removeLastDrawnElement:function(){m&&n.viewer.removeOverlay(m)}},n}((viewImage=function(r){"use strict";var n=!0,i=5,t=!0,a=null,l=null;function e(e){if(n){a&&t&&r.viewer.removeOverlay(a),(a=document.createElement("div")).style.border="2px solid green",l=r.viewer.viewport.viewerElementToViewportCoordinates(e.position),l=r.overlays.getRotated(l);var o=new OpenSeadragon.Rect(l.x,l.y,0,0);return r.viewer.addOverlay(a,o,1),e.preventDefaultAction=!0}}function o(e){if(n){var o=r.viewer.viewport.viewerElementToViewportCoordinates(e.position);o=r.overlays.getRotated(o);var t=new OpenSeadragon.Rect(l.x,l.y,o.x-l.x,o.y-l.y);return o.x<l.x&&(t.x=o.x,t.width=l.x-o.x),o.y<l.y&&(t.y=o.y,t.height=l.y-o.y),r.viewer.updateOverlay(a,t,0),e.preventDefaultAction=!0}}function s(e){if(n){var o=r.viewer.viewport.viewerElementToViewportCoordinates(e.position);o=r.overlays.getRotated(o);var t=new OpenSeadragon.Rect(l.x,l.y,o.x-l.x,o.y-l.y);return o.x<l.x&&(t.x=o.x,t.width=l.x-o.x),o.y<l.y&&(t.y=o.y,t.height=l.y-o.y),t.hitBox={l:t.x-i,t:t.y-i,r:t.x+t.width+i,b:t.y+t.height+i},e.preventDefaultAction=!0}}function c(e){if(n)return e.preventDefaultAction=!0}return r.drawLine={init:function(){r.viewer.addViewerInputHook({hooks:[{tracker:"viewer",handler:"clickHandler",hookHandler:c},{tracker:"viewer",handler:"scrollHandler",hookHandler:c},{tracker:"viewer",handler:"dragHandler",hookHandler:o},{tracker:"viewer",handler:"pressHandler",hookHandler:e},{tracker:"viewer",handler:"dragEndHandler",hookHandler:s}]})},toggleDrawing:function(){n=!n}},r}((viewImage=function(n){"use strict";function i(e){return"number"==typeof e&&!Number.isNaN(e)}return n.controls.persistence={init:function(e){if("undefined"!=typeof Storage){var o=null,t=n.getConfig().global.persistenceId;if(e.global.persistZoom||e.global.persistRotation){try{o=JSON.parse(localStorage.imageLocation)}catch(e){0}o&&(i((r=o).x)&&i(r.y)&&i(r.zoom)&&i(r.rotation))&&o.persistenceId===t&&(e.image.location={},e.global.persistZoom&&(e.image.location.zoom=o.zoom,e.image.location.x=o.x,e.image.location.y=o.y),e.global.persistRotation?e.image.location.rotation=o.rotation:e.image.location.rotation=0),window.onbeforeunload=function(){var e=n.controls.getLocation();e.persistenceId=n.getConfig().global.persistenceId,localStorage.imageLocation=JSON.stringify(e)}}}var r}},n}((viewImage=function(t){"use strict";var n=!1,o=!1,e=null;return t.controls={init:function(e){n&&(console.log("##############################"),console.log("osViewer.controls.init"),console.log("##############################")),t.controls.persistence&&t.controls.persistence.init(e),n&&console.log("Setting viewer location to",e.image.location),t.observables&&(t.observables.redrawRequired.sample(t.observables.viewportUpdate).filter(function(e){return!!t.controls}).subscribe(function(e){!function(e,o){n&&(console.log("Viewer changed from "+e.osState+" event"),console.log("target location: ",e.targetLocation),console.log("Home zoom = ",o.viewer.viewport.getHomeZoom()));o.viewer.viewport.minZoomLevel=o.viewer.viewport.getHomeZoom()*o.getConfig().global.minZoomLevel;var t=e.targetLocation.zoom,r=new OpenSeadragon.Point(e.targetLocation.x,e.targetLocation.y);t*o.viewer.viewport.getHomeZoom()-o.viewer.viewport.minZoomLevel<.001||!t?(n&&console.log("Zooming home"),o.controls.goHome(!0)):(n&&(console.log("Zooming to "+t+" * "+o.controls.getCurrentRotationZooming()),console.log("panning to ",r)),o.viewer.viewport.zoomTo(t*o.controls.getCurrentRotationZooming(),null,!0),o.controls.setCenter(r));"open"===e.osState&&0!==e.targetLocation.rotation&&o.controls.rotateTo(e.targetLocation.rotation)}(e,t),t.controls.setPanning(!1)}),t.observables.viewerZoom.subscribe(function(e){(n&&console.log("zoom to "+t.viewer.viewport.getZoom(!0)),t.controls.isPanning())||t.viewer.viewport.getZoom()<=t.viewer.viewport.minZoomLevel&&(n&&console.log("Zoomed out: Panning home"),t.controls.setPanning(!0),t.controls.goHome(!0),t.controls.setPanning(!1))})),0<$("#fullscreenTemplate").length&&($("#fullscreenTemplate").on("mousemove",function(){t.controls.fullscreenControlsFadeout()}),$("#fullscreenMap").on("touchmove",function(){t.controls.fullscreenControlsFadeout()}).on("touchend",function(){t.controls.fullscreenControlsFadeout()}))},getLocation:function(){return{x:t.controls.getCenter().x,y:t.controls.getCenter().y,zoom:t.controls.getZoom()/t.controls.getCurrentRotationZooming(),rotation:t.controls.getRotation()}},getCenter:function(){return n&&console.log("image center is "+t.viewer.viewport.getCenter(!0)),t.viewer.viewport.getCenter(!0)},setCenter:function(e){n&&(console.log("Setting image center to "),console.log(e)),t.viewer.viewport.panTo(e,!0)},getZoom:function(){return n&&console.log("osViewer.controls.getZoom"),t.viewer.viewport.getZoom(!0)},zoomTo:function(e){n&&console.log("osViewer.controls.myZoomTo: zoomTo - "+e);var o=parseFloat(e)/t.viewer.viewport.getZoom();n&&console.log("osViewer.controls.myZoomTo: zoomBy - "+o),t.viewer.viewport.zoomBy(o,t.viewer.viewport.getCenter(!1),!0)},setFullScreen:function(e){n&&console.log("osViewer.controls.setFullScreen: enable - "+e),t.viewer.setFullScreen(e)},goHome:function(e){n&&console.log("osViewer.controls.panHome - zoom : "+t.viewer.viewport.getHomeZoom()),t.viewer.viewport.goHome(e),!0},reset:function(e){n&&console.log("osViewer.controls.goHome: bool - "+e),t.controls.goHome(!0),t.viewer.viewport.zoomTo(t.viewer.viewport.getHomeZoom(),null,!0),e&&t.controls.rotateTo(0)},zoomIn:function(){n&&console.log("osViewer.controls.zoomIn: zoomSpeed - "+t.getConfig().global.zoomSpeed),t.viewer.viewport.zoomBy(t.getConfig().global.zoomSpeed,t.viewer.viewport.getCenter(!1),!1)},zoomOut:function(){n&&console.log("osViewer.controls.zoomOut: zoomSpeed - "+t.getConfig().global.zoomSpeed),t.viewer.viewport.zoomBy(1/t.getConfig().global.zoomSpeed,t.viewer.viewport.getCenter(!1),!1)},getHomeZoom:function(e){e&&t.getCanvasSize().x/t.getCanvasSize().y<=t.getImageSize().x/t.getImageSize().y&&(t.viewer.viewport.homeFillsViewer=!0);var o=t.viewer.viewport.getHomeZoom();return t.viewer.viewport.homeFillsViewer=!1,o},rotateRight:function(){n&&console.log("osViewer.controls.rotateRight");var e=t.viewer.viewport.getRotation()+90;t.controls.rotateTo(e)},rotateLeft:function(){n&&console.log("osViewer.controls.rotateLeft");var e=t.viewer.viewport.getRotation()-90;t.controls.rotateTo(e)},getRotation:function(){return n&&console.log("osViewer.controls.getRotation"),t.viewer.viewport.getRotation()},setRotation:function(e){return n&&console.log("osViewer.controls.setRotation: rotation - "+e),t.controls.rotateTo(e)},rotateTo:function(e){e<0&&(e+=360),e%=360,n&&console.log("osViewer.controls.rotateTo: newRotation - "+e),o=!0,null,t.viewer.viewport.setRotation(e),o=!1},getCurrentRotationZooming:function(){var e=t.getSizes();return e&&e.rotated()?1/e.ratio(e.originalImageSize):1},setPanning:function(e){o=e},isPanning:function(){return o},fullscreenControlsFadeout:function(){n&&console.log("---------- osViewer.controls.fullscreenControlsFadeout() ----------"),e&&(clearTimeout(e),this.showFullscreenControls()),e=setTimeout(this.hideFullscreenControls,3e3)},hideFullscreenControls:function(){n&&console.log("---------- osViewer.controls.hideFullscreenControls() ----------"),$("#fullscreenRotateControlsWrapper, #fullscreenZoomSliderWrapper, #fullscreenExitWrapper, #fullscreenPrevWrapper, #fullscreenNextWrapper").stop().fadeOut("slow")},showFullscreenControls:function(){n&&console.log("---------- osViewer.controls.showFullscreenControls() ----------"),$("#fullscreenRotateControlsWrapper, #fullscreenZoomSliderWrapper, #fullscreenExitWrapper, #fullscreenPrevWrapper, #fullscreenNextWrapper").show()}},t}(viewImage||{},jQuery))||{},jQuery))||{},jQuery))||{},jQuery))||{},jQuery))||{},jQuery))||{},jQuery))||{},jQuery))||{},jQuery))||{},jQuery);
//# sourceMappingURL=viewImage.min.js.map