<ui:composition xmlns="http://www.w3.org/1999/xhtml"
	xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
	xmlns:h="http://xmlns.jcp.org/jsf/html"
	xmlns:c="http://java.sun.com/jsp/jstl/core"
	xmlns:f="http://xmlns.jcp.org/jsf/core"
	template="/resources/themes/#{navigationHelper.theme}/template.html"
	xmlns:viewer="http://xmlns.jcp.org/jsf/composite/components/partner"
	xmlns:viewerComponent="http://xmlns.jcp.org/jsf/composite/components" 
	xmlns:widgetComponent="http://xmlns.jcp.org/jsf/composite/components/widgets">

	<ui:define name="metadata">
		<f:metadata>
			<f:event type="preRenderView" listener="#{navigationHelper.setCurrentView('metadata')}" />
		</f:metadata>
	</ui:define>

	<ui:define name="head">
		<f:view contentType="text/html" encoding="utf-8">
			<h:outputText escape="false"
				value="#{activeDocumentBean.viewManager.htmlHeadDCMetadata}"
				rendered="#{navigationHelper.htmlHeadDCMetadata == true}" />
		</f:view>
	</ui:define>

	<ui:define name="content">
		<f:view contentType="text/html" encoding="utf-8">
		 <!-- reCAPTCHA API -->
            <h:panelGroup rendered="#{configurationBean.useReCaptcha}">
                <script src="https://www.google.com/recaptcha/api.js" async="async" defer="defer"></script>
            </h:panelGroup>
            
			<div id="view_metadata">

				<h2>#{msg.bibData}</h2>
				
				<viewerComponent:changeRecordLocale />

				<div id="metadataElementWrapper">
					<ui:repeat value="#{metadataBean.metadataElementList}" var="metadataElement" varStatus="status">
						<div class="metadata-element-box level-#{status.index}">
							<ui:repeat value="#{metadataElement.metadataList}" var="metadata">
								<h:panelGroup rendered="#{!metadata.blank}">
									<div class="metadata-element">
										<dl class="dl-horizontal">
											<dt title="#{msg[metadata.label]}">
												<h:outputText value="#{msg[metadata.label]}:" escape="false" />
											</dt>
											<h:panelGroup rendered="#{metadata.group}">
												<dd>
													<ui:repeat value="#{metadata.values}" var="val">
														<h:outputFormat value="#{msg[val.masterValue]}"
															escape="false">
															<f:param value="#{val.getParamLabelWithColon(0)}" />
															<f:param value="#{val.getComboValueShort(0)}" />
															<f:param value="#{val.getParamLabelWithColon(1)}" />
															<f:param value="#{val.getComboValueShort(1)}" />
															<f:param value="#{val.getParamLabelWithColon(2)}" />
															<f:param value="#{val.getComboValueShort(2)}" />
															<f:param value="#{val.getParamLabelWithColon(3)}" />
															<f:param value="#{val.getComboValueShort(3)}" />
															<f:param value="#{val.getParamLabelWithColon(4)}" />
															<f:param value="#{val.getComboValueShort(4)}" />
															<f:param value="#{val.getParamLabelWithColon(5)}" />
															<f:param value="#{val.getComboValueShort(5)}" />
															<f:param value="#{val.getParamLabelWithColon(6)}" />
															<f:param value="#{val.getComboValueShort(6)}" />
															<f:param value="#{val.getParamLabelWithColon(7)}" />
															<f:param value="#{val.getComboValueShort(7)}" />
															<f:param value="#{val.getParamLabelWithColon(8)}" />
															<f:param value="#{val.getComboValueShort(8)}" />
															<f:param value="#{val.getParamLabelWithColon(9)}" />
															<f:param value="#{val.getComboValueShort(9)}" />
														</h:outputFormat>

														<!-- NORMDATA -->
                                                        <viewerComponent:normdata />
                                                        <br />
													</ui:repeat>
												</dd>
											</h:panelGroup>
											
											<h:panelGroup rendered="#{!metadata.group}">
												<dd>
													<ui:repeat value="#{metadata.values}" var="val">
														<span class="metadata-value">
															<h:outputFormat value="#{msg[val.masterValue]}" escape="false">
																<f:param value="#{val.getComboValueShort(0)}" />
																<f:param value="#{val.getComboValueShort(1)}" />
																<f:param value="#{val.getComboValueShort(2)}" />
																<f:param value="#{val.getComboValueShort(3)}" />
																<f:param value="#{val.getComboValueShort(4)}" />
																<f:param value="#{val.getComboValueShort(5)}" />
																<f:param value="#{val.getComboValueShort(6)}" />
																<f:param value="#{val.getComboValueShort(7)}" />
																<f:param value="#{val.getComboValueShort(8)}" />
																<f:param value="#{val.getComboValueShort(9)}" />
															</h:outputFormat>
														</span>
													</ui:repeat>
												</dd>
											</h:panelGroup>
										</dl>
									</div>
								</h:panelGroup>
							</ui:repeat>
						</div>
					</ui:repeat>

					<c:forEach items="#{metadataBean.events}" var="event">
						<div class="metadata-event-box">
							<ui:repeat value="#{event.metadata}" var="metadata">
								<h:panelGroup rendered="#{!metadata.blank}">
									<div class="metadata-event">
										<dl class="dl-horizontal">
											<dt title="#{msg[metadata.label]}">
												<h:outputText value="#{msg[metadata.label]}:" escape="false" />
											</dt>
											<h:panelGroup>
												<dd>
													<ui:repeat value="#{metadata.values}" var="val">
														<span class="metadata-value">
															<h:outputFormat value="#{msg[val.masterValue]}" escape="false">
																<f:param value="#{val.paramValues[0] != null ? val.paramValues[0] : ''}" />
																<f:param value="#{val.paramValues[1] != null ? val.paramValues[1] : ''}" />
																<f:param value="#{val.paramValues[2] != null ? val.paramValues[2] : ''}" />
																<f:param value="#{val.paramValues[3] != null ? val.paramValues[3] : ''}" />
															</h:outputFormat>
														</span>
													</ui:repeat>
												</dd>
											</h:panelGroup>
										</dl>
									</div>
								</h:panelGroup>
							</ui:repeat>
						</div>
					</c:forEach>
				</div>
                
                <div class="clearfix"></div>
				
				<!-- ePUBLICATIONS -->
                <h:panelGroup rendered="#{activeDocumentBean.viewManager.filesOnly and activeDocumentBean.viewManager.hasPages}">
                    <viewerComponent:ePub />
                </h:panelGroup>
				
				<div class="clearfix"></div>

				<h3>#{msg.downloads}</h3>
                
                <h:form
                    id="viewMetadataDownloadsForm"
                    rendered="#{configurationBean.displayMetadataPageLinkBlock}"
                    prependId="false">
                    <nav
                        id="viewMetadataDownloads"
                        class="dl-links">
                        <ul>
                            <li class="dl-links__mets">
                                <h:outputLink
                                    id="metsLink"
                                    styleClass="btn"
                                    rendered="#{activeDocumentBean.viewManager.activeDocument.sourceDocFormat == 'METS'}"
                                    value="#{activeDocumentBean.viewManager.metsResolverUrl}"
                                    title="#{msg.metadata_dl_mets}"
                                    target="_blank"> 
									#{msg.downloadMetsButtonLabel}
                                    <f:passThroughAttribute name="data-toggle" value="tooltip" />
                                    <f:passThroughAttribute name="data-placement" value="top" />
								</h:outputLink>
                                <h:outputLink
                                    id="lidoLink"
                                    styleClass="btn"
                                    rendered="#{activeDocumentBean.viewManager.activeDocument.sourceDocFormat == 'LIDO'}"
                                    value="#{activeDocumentBean.viewManager.lidoResolverUrl}"
                                    title="#{msg.metadata_dl_lido}"
                                    target="_blank"> 
									#{msg.downloadLidoButtonLabel}
                                    <f:passThroughAttribute name="data-toggle" value="tooltip" />
                                    <f:passThroughAttribute name="data-placement" value="top" />
								</h:outputLink>
                            </li>
                            <h:panelGroup rendered="#{activeDocumentBean.viewManager.anchorMetsResolverUrl != null}">
                                <li class="dl-links__mets-all">
                                    <h:outputLink
                                        id="metsAnchorLink"
                                        styleClass="btn"
                                        value="#{activeDocumentBean.viewManager.anchorMetsResolverUrl}"
                                        title="#{msg.metadata_dl_metsAnchor}"
                                        target="_blank">
										#{msg.downloadAnchorMetsButtonLabel}
                                        <f:passThroughAttribute name="data-toggle" value="tooltip" />
                                        <f:passThroughAttribute name="data-placement" value="top" />
									</h:outputLink>
                                </li>
                            </h:panelGroup>
                            <li class="dl-links__marcxml">
                                <a
                                    id="marc"
                                    href="#{activeDocumentBean.viewManager.oaiMarcUrl}"
                                    class="btn"
                                    title="#{msg.metadata_dl_marc}"
                                    data-toggle="tooltip"
                                    data-placement="top"
                                    target="_blank">#{msg.marcLink}</a>
                            </li>
                            <li class="dl-links__dc">
                                <a
                                    id="dc"
                                    href="#{activeDocumentBean.viewManager.oaiDcUrl}"
                                    class="btn"
                                    title="#{msg.metadata_dl_dublinCore}"
                                    data-toggle="tooltip"
                                    data-placement="top"
                                    target="_blank"> #{msg.dcLink} </a>
                            </li>
                            <h:panelGroup rendered="#{activeDocumentBean.viewManager.oaiEseUrl != null}">
                                <li class="dl-links__ese">
                                    <a
                                        id="eseLink"
                                        href="#{activeDocumentBean.viewManager.oaiEseUrl}"
                                        class="btn"
                                        title="#{msg.metadata_dl_ese}"
                                        data-toggle="tooltip"
                                        data-placement="top"
                                        target="_blank">#{msg.eseLink}</a>
                                </li>
                            </h:panelGroup>
                            <h:panelGroup rendered="#{activeDocumentBean.viewManager.opacUrl != null}">
                                <li class="dl-links__opac">
                                    <a
                                        id="opacLink"
                                        href="#{activeDocumentBean.viewManager.opacUrl}"
                                        class="btn"
                                        title="#{msg.metadata_dl_opac}"
                                        data-toggle="tooltip"
                                        data-placement="top"
                                        target="_blank">#{msg.opacLink}</a>
                                </li>
                            </h:panelGroup>
                            <h:panelGroup
                                rendered="#{!activeDocumentBean.anchor and activeDocumentBean.viewManager.linkForDFGViewer != null and !activeDocumentBean.viewManager.filesOnly and activeDocumentBean.viewManager.hasPages}">
                                <li class="dl-links__dfg">
                                    <h:outputLink
                                        id="dfgLink"
                                        styleClass="btn"
                                        value="#{activeDocumentBean.viewManager.linkForDFGViewer}"
                                        title="#{msg.metadata_dl_dfg}"
                                        target="_blank">
										#{msg.dfgViewerLink}
                                        <f:passThroughAttribute name="data-toggle" value="tooltip" />
                                        <f:passThroughAttribute name="data-placement" value="top" />
									</h:outputLink>
                                </li>
                            </h:panelGroup>
                            <h:panelGroup rendered="#{!activeDocumentBean.viewManager.filesOnly and activeDocumentBean.viewManager.hasPages}">
                                <h:panelGroup rendered="#{activeDocumentBean.accessPermissionPdf}">
                                    <h:panelGroup rendered="#{!configurationBean.generatePdfInTaskManager}">
                                        <li class="dl-links__pdf">
                                            <a
                                                id="pdfDownloadLink"
                                                href="#{activeDocumentBean.viewManager.pdfDownloadLink}"
                                                title="#{msg.metadata_dl_pdf}"
                                                data-toggle="tooltip"
                                                data-placement="top"
                                                class="btn">#{msg.pdfDownload}</a>
                                        </li>
                                    </h:panelGroup>
                                    <h:panelGroup rendered="#{configurationBean.generatePdfInTaskManager}">
                                        <li class="dl-links__pdf">
                                            <a
                                                href="#"
                                                class="btn download-modal"
                                                data-type="pdf"
                                                data-title="#{activeDocumentBean.titleBarLabel}"
                                                data-id=""
                                                data-pi="#{activeDocumentBean.viewManager.pi}"
                                                title="#{msg.pdfDownload}"
                                                data-toggle="tooltip"
                                                data-placement="top">#{msg.pdfDownload}</a>
                                        </li>
                                    </h:panelGroup>
                                </h:panelGroup>
                            </h:panelGroup>
                            
                            <!-- EPUB DOWNLOAD -->
                            <h:panelGroup rendered="#{activeDocumentBean.accessPermissionEpub}">
                                <li class="dl-links__epub">
                                    <a
                                        href="#"
                                        class="btn download-modal"
                                        data-type="epub"
                                        data-title="#{activeDocumentBean.titleBarLabel}"
                                        data-id=""
                                        data-pi="#{activeDocumentBean.viewManager.pi}"
                                        title="#{msg.epubDownload}"> #{msg.epubDownload} </a>
                                </li>
                            </h:panelGroup>
                        </ul>
                    </nav>
                </h:form>
                <div class="clearfix"></div>
			</div>
			
			 <h:panelGroup rendered="#{userBean.loggedIn}">
                <input id="userEmail" type="hidden" value="#{userBean.user.email}" />
            </h:panelGroup>            
			
		</f:view>

		<script type="text/javascript">            
            var normdataConfig = {
                path: '#{request.contextPath}',
                lang: {
                    popoverTitle: '#{msg.normdataPopverTitle}',
                    popoverClose: '#{msg.normdataPopoverClose}',
                    showNormdata: '#{msg.normdataExpand}'
                },
                elemWrapper: $( '#metadataElementWrapper' )
            };
            
            viewerJS.normdata.init( normdataConfig );
            
            var downloadModalConfig = {
                	downloadBtn: $( '.download-modal' ),
                    path: '#{navigationHelper.applicationUrl}',
                    iiifPath: '#{configurationBean.iiifApiUrl}',
                    userEmail: $( '#userEmail' ).val(),
                    useReCaptcha: #{configurationBean.useReCaptcha},
                    reCaptchaSiteKey: '#{configurationBean.reCaptchaSiteKey}',
                    messages: {
                        downloadInfo: {
                            text: '#{msg.downloadInfoText}',
                            title: '#{msg.downloadInfoTitle}',
                            part: '#{msg.downloadInfoPart}',
                            fileSize: '#{msg.downloadInfoFileSize}'
                        },
                        reCaptchaText: '#{msg.downloadReCaptchaText}',
                        rcInvalid: '#{msg.downloadRcInvalid}',
                        rcValid: '#{msg.downloadRcValid}',
                        eMailText: '#{msg.downloadEMailText}',
                        eMailTextLoggedIn: '#{msg.downloadEMailTextLoggedIn}',
                        eMail: '#{msg.downloadEmail}',
                        closeBtn: '#{msg.downloadCloseModal}',
                        saveBtn: '#{msg.downloadGenerateFile}',
                    }
                };
            
                viewerJS.downloadModal.init( downloadModalConfig );
        </script>
	</ui:define>

	<ui:define name="sidebar">
		<widgetComponent:widget_views pageType="metadata"/>
        
        <widgetComponent:widget_searchInCurrentItem />
        
        <widgetComponent:widget_nerFacetting />

		<widgetComponent:widget_searchResultNavigation />
		
		<widgetComponent:widget_convolutes />
        
        <widgetComponent:widget_toc />

		<widgetComponent:widget_download />
		
		<widgetComponent:widget_versionHistory />

		<widgetComponent:widget_bookshelfList />
        
        <widgetComponent:widget_mySearches />
        
        <c:forEach var="module" items="#{configurationBean.modules}">
            <c:forEach var="contribution" items="#{module.sidebarContributions}">
                <ui:include src="/#{contribution}" />
            </c:forEach>
        </c:forEach>
        
		<widgetComponent:widget_user />
	</ui:define>

	<ui:define name="breadcrumbs">
		<ui:include src="/resources/includes/breadcrumbs.xhtml" />
	</ui:define>
</ui:composition>
